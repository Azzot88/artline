{% extends "base.html" %}

{% block content %}
<div class="container-fluid h-100 p-0" style="min-height: calc(100vh - 56px);">
    <div class="row g-0 h-100">

        <!-- LEFT COLUMN: Navigation & History (25%) -->
        <div class="col-lg-3 col-md-4 d-none d-md-flex flex-column border-end border-secondary bg-dark bg-opacity-50"
            style="backdrop-filter: blur(10px); height: calc(100vh - 56px); overflow-y: auto;">

            <!-- User Balance -->
            <div class="p-3 border-bottom border-secondary">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-white-50 text-uppercase small ls-1">{{ t.balance_title|default('Balance') }}
                    </h6>
                    <a href="/services/billing" class="btn btn-sm btn-outline-success border-0"><i
                            class="bi bi-plus-lg"></i> Top Up</a>
                </div>
                {% include "partials/balance_badge.html" %}
            </div>

            <!-- Navigation Links -->
            <div class="list-group list-group-flush">
                <a href="#" class="list-group-item list-group-item-action bg-transparent text-white active border-0"
                    onclick="showSection('create')">
                    <i class="bi bi-magic me-2"></i> {{ t.nav_create|default('Create') }}
                </a>
                <a href="#" class="list-group-item list-group-item-action bg-transparent text-white-50 border-0"
                    onclick="showSection('gallery')">
                    <i class="bi bi-images me-2"></i> {{ t.nav_gallery|default('Gallery') }}
                </a>
                <a href="#" class="list-group-item list-group-item-action bg-transparent text-white-50 border-0"
                    onclick="showSection('history')">
                    <i class="bi bi-clock-history me-2"></i> {{ t.nav_history|default('History') }}
                </a>
            </div>

            <!-- Mini Gallery / Recent -->
            <div class="p-3 mt-auto">
                <h6 class="text-white-50 text-uppercase small ls-1 mb-3">Recent Generations</h6>
                <div id="mini-gallery" class="d-grid gap-2" style="grid-template-columns: repeat(3, 1fr);">
                    <!-- Partial load of recent jobs -->
                    {% for job in jobs[:6] %}
                    <div
                        class="ratio ratio-1x1 bg-dark rounded border border-secondary overflow-hidden position-relative">
                        {% if job.kind == 'video' %}
                        <video src="{{ job.result_url }}" class="w-100 h-100 object-fit-cover"></video>
                        <i class="bi bi-camera-reels position-absolute top-0 end-0 m-1 text-white small shadow"></i>
                        {% else %}
                        <img src="{{ job.icon_url or job.result_url }}" class="w-100 h-100 object-fit-cover">
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Workspace (75%) -->
        <div class="col-lg-9 col-md-8 bg-black">
            <div class="container py-4" style="max-width: 900px;">

                <!-- Main Form -->
                <!-- Main Form (Styled like Reference) -->
                <form id="generateForm" hx-post="/dashboard/jobs/new" hx-swap="none" class="position-relative">

                    <!-- Main Card Container -->
                    <div class="card border border-secondary shadow-lg overflow-hidden"
                        style="background-color: #0f0f0f; border-color: #333 !important; border-radius: 12px;">

                        <!-- Header: Toggles & Tabs -->
                        <div class="card-header border-0 pb-0 pt-3 px-4 d-flex align-items-center mb-2"
                            style="background: transparent;">
                            <!-- Mode Switch (Image/Video as Icons) -->
                            <div class="btn-group me-4 p-1 rounded bg-dark border border-secondary" role="group">
                                <input type="radio" class="btn-check" name="kind" id="modeImage" value="image" checked
                                    onchange="app.setMode('image')">
                                <label class="btn btn-sm btn-link text-white text-decoration-none px-2 py-0 border-0"
                                    for="modeImage" title="Image Mode">
                                    <i class="bi bi-image fs-5"></i>
                                </label>

                                <input type="radio" class="btn-check" name="kind" id="modeVideo" value="video"
                                    onchange="app.setMode('video')">
                                <label class="btn btn-sm btn-link text-white-50 text-decoration-none px-2 py-0 border-0"
                                    for="modeVideo" title="Video Mode">
                                    <i class="bi bi-camera-reels fs-5"></i>
                                </label>
                            </div>

                            <!-- Source Tabs -->
                            <div class="d-flex gap-4">
                                <div class="cursor-pointer pb-2 border-bottom border-2 border-transparent text-white-50 fw-bold header-tab"
                                    id="tabText" onclick="app.setSource('text')">
                                    Text to Image
                                </div>
                                <div class="cursor-pointer pb-2 border-bottom border-2 border-white text-white fw-bold header-tab"
                                    id="tabImage" onclick="app.setSource('image')">
                                    Image to Image
                                </div>
                            </div>

                            <div class="ms-auto text-white-50 small">
                                <i class="bi bi-info-circle"></i> Prompt tips
                            </div>
                        </div>

                        <!-- Body: Upload & Prompt -->
                        <div class="card-body px-4 py-2" style="min-height: 140px;">

                            <!-- Image Input Trigger (Small Icon) -->
                            <div id="uploadArea" class="mb-2 d-none">
                                <div class="d-inline-block border border-secondary rounded p-2 text-center cursor-pointer hover-white position-relative"
                                    style="width: 48px; height: 48px; border-style: dashed !important;"
                                    onclick="document.getElementById('fileInput').click()">
                                    <i class="bi bi-plus-lg text-white-50"></i>

                                    <!-- Preview Overlay -->
                                    <div id="miniPreview"
                                        class="position-absolute top-0 start-0 w-100 h-100 d-none bg-dark rounded overflow-hidden">
                                        <img src="" class="w-100 h-100 object-fit-cover" id="imgPreviewTag">
                                    </div>
                                </div>
                                <input type="file" id="fileInput" name="init_image" class="d-none"
                                    onchange="app.handleFile(this)">
                                <button type="button" class="btn btn-link btn-sm text-danger p-0 ms-2 align-top d-none"
                                    id="clearFileBtn" onclick="app.clearFile()">x</button>
                            </div>

                            <!-- Input Field -->
                            <textarea name="prompt" id="promptInput"
                                class="form-control bg-transparent border-0 text-white px-0 fs-5"
                                style="resize: none; box-shadow: none;" rows="3"
                                placeholder="Describe how to transform your image (e.g. 'swap the sky with a sunset') or blend 2-3 images..."
                                required oninput="app.updateState()"></textarea>
                        </div>

                        <!-- Footer: Controls -->
                        <div class="card-footer bg-transparent border-0 px-4 pb-4 pt-2">

                            <!-- Limits / Warning -->
                            <div id="limitMsg" class="text-warning small mb-3 d-none">
                                You've reached your free limit. <a href="/services/billing"
                                    class="text-warning fw-bold">Subscribe now</a> to keep generating.
                            </div>

                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">

                                <!-- Left: Selectors -->
                                <div class="d-flex gap-2">
                                    <!-- Model Selector -->
                                    <div class="dropdown">
                                        <button
                                            class="btn btn-dark border border-secondary rounded-3 text-start d-flex align-items-center gap-2 px-3"
                                            type="button" data-bs-toggle="dropdown" style="background: #222;">
                                            <span id="selectedModelIcon">üçå</span>
                                            <span id="selectedModelName" class="text-white small fw-bold">Select
                                                Model</span>
                                            <i class="bi bi-chevron-down ms-2 text-white-50 small"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-dark shadow-lg p-0" id="modelDropdown"
                                            style="max-height: 300px; overflow-y: auto;">
                                            <!-- JS Populated -->
                                        </ul>
                                        <input type="hidden" name="model" id="selectedModelInput">
                                    </div>

                                    <!-- Aspect Ratio Selector -->
                                    <div class="dropdown">
                                        <button
                                            class="btn btn-dark border border-secondary rounded-3 d-flex align-items-center gap-2 px-3"
                                            type="button" data-bs-toggle="dropdown" style="background: #222;">
                                            <i class="bi bi-square"></i>
                                            <span id="selectedRatio" class="text-white small fw-bold">1:1</span>
                                            <i class="bi bi-chevron-down text-white-50 small"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-dark shadow-lg" id="ratioDropdown">
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="app.setRatio('1024x1024', '1:1')"><i
                                                        class="bi bi-square me-2"></i> 1:1 (Square)</a></li>
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="app.setRatio('896x1152', '3:4')"><i
                                                        class="bi bi-phone me-2"></i> 3:4 (Portrait)</a></li>
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="app.setRatio('1152x896', '4:3')"><i
                                                        class="bi bi-aspect-ratio me-2"></i> 4:3 (Landscape)</a></li>
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="app.setRatio('1344x768', '16:9')"><i
                                                        class="bi bi-film me-2"></i> 16:9 (Wide)</a></li>
                                        </ul>
                                        <input type="hidden" name="resolution" id="selectedRatioInput">
                                    </div>

                                    <!-- Additional Params Container (Hidden by default, used for durations etc) -->
                                    <div id="extraParams" class="d-none"></div>
                                </div>

                                <!-- Right: Generate Button -->
                                <div>
                                    <button type="submit" id="mainGenerateBtn"
                                        class="btn btn-warning fw-bold px-4 py-2 d-flex align-items-center gap-2"
                                        style="background-color: #ffd600; border: none; color: #000;">
                                        Generate <span id="costDisplay">100</span> <i class="bi bi-stars"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>

<script>
    // Embed Models Data
    const MODELS = {{ models_json| safe }};

    const app = {
        state: {
            mode: 'image', // image | video
            source: 'text', // text | image
            modelId: null,
            hasFile: false
        },

        init() {
            this.setMode('image');
            // Auto select first valid model
            this.updateModels();
            this.updateState();
        },

        setMode(mode) {
            this.state.mode = mode;

            // Update UI Labels
            const txtBtn = document.getElementById('lblSourceText');
            const imgBtn = document.getElementById('lblSourceImage');

            if (mode === 'image') {
                txtBtn.textContent = "Text to Image";
                imgBtn.textContent = "Image to Image";
            } else {
                txtBtn.textContent = "Text to Video";
                imgBtn.textContent = "Image to Video";
            }

            this.setSource('text'); // Reset source preference? Or keep? Reset is safer.
            this.updateModels();
        },

        setSource(source) {
            this.state.source = source;
            document.getElementById('btnSourceText').classList.toggle('active', source === 'text');
            document.getElementById('btnSourceImage').classList.toggle('active', source === 'image');

            const uploadArea = document.getElementById('uploadArea');
            if (source === 'image') {
                uploadArea.classList.remove('d-none');
            } else {
                uploadArea.classList.add('d-none');
            }
            this.updateModels();
        },

        handleFile(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const prev = document.getElementById('filePreview');
                    prev.classList.remove('d-none');
                    prev.querySelector('img').src = e.target.result;
                    this.state.hasFile = true;
                };
                reader.readAsDataURL(input.files[0]);
            }
        },

        clearFile() {
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreview').classList.add('d-none');
            this.state.hasFile = false;
        },

        updateModels() {
            const container = document.getElementById('modelList');
            container.innerHTML = '';

            // Filter Models
            const neededMode = this.state.source === 'text'
                ? `text-to-${this.state.mode}`
                : `image-to-${this.state.mode}`;

            // If legacy data missing 'modes' field, fallback to basic logic
            // Assuming legacy is text-to-image mostly.

            const validModels = MODELS.filter(m => {
                if (!m.modes || m.modes.length === 0) return this.state.mode === 'image' && this.state.source === 'text';
                return m.modes.includes(neededMode);
            });

            if (validModels.length === 0) {
                container.innerHTML = '<div class="text-muted small">No models available for this mode.</div>';
                return;
            }

            validModels.forEach((m, idx) => {
                const isSelected = (this.state.modelId === m.id) || (idx === 0 && !this.state.modelId);
                if (isSelected) this.selectModel(m.id);

                const el = document.createElement('div');
                el.className = `card flex-shrink-0 cursor-pointer ${isSelected ? 'border-primary bg-primary bg-opacity-10' : 'border-secondary bg-dark'}`;
                el.style.width = '160px';
                el.onclick = () => this.selectModel(m.id);
                el.innerHTML = `
                    <div class="card-body p-2 text-center">
                        <div class="ratio ratio-1x1 mb-2 rounded bg-black overflow-hidden">
                             <img src="${m.cover || '/static/placeholder.png'}" class="object-fit-cover">
                        </div>
                        <h6 class="card-title text-white small mb-0 text-truncate">${m.name}</h6>
                        <small class="text-muted" style="font-size: 0.7em;">${m.provider}</small>
                    </div>
                `;
                container.appendChild(el);
            });

            // Re-render model list to highlight selection? Or just manipulating class above is enough for loop.
            // Actually loop runs once. Better to enforce selection visual update separately? 
            // For MVP, re-rendering is fast enough.
        },

        selectModel(id) {
            this.state.modelId = id;
            document.getElementById('selectedModelId').value = id;

            // Highlight UI
            const cards = document.getElementById('modelList').children;
            Array.from(cards).forEach(c => {
                c.classList.remove('border-primary', 'bg-primary', 'bg-opacity-10');
                c.classList.add('border-secondary', 'bg-dark');
                if (c.onclick.toString().includes(id)) { // Hacky check or just loop models
                    c.classList.remove('border-secondary', 'bg-dark');
                    c.classList.add('border-primary', 'bg-primary', 'bg-opacity-10');
                }
            });

            this.renderParams();
            this.calcCost();
        },

        renderParams() {
            const m = MODELS.find(x => x.id === this.state.modelId);
            const container = document.getElementById('paramsContainer');
            container.innerHTML = '';

            if (!m) return;

            // Resolutions
            if (m.resolutions && m.resolutions.length > 0) {
                const col = document.createElement('div');
                col.className = 'col-md-6';
                col.innerHTML = `
                    <label class="form-label text-white-50 small">Resolution</label>
                    <select name="resolution" class="form-select form-select-sm bg-dark text-white border-secondary" onchange="app.calcCost()">
                        ${m.resolutions.map(r => `<option value="${r}">${r}</option>`).join('')}
                    </select>
                `;
                container.appendChild(col);
            }

            // Durations
            if (this.state.mode === 'video' && m.durations && m.durations.length > 0) {
                const col = document.createElement('div');
                col.className = 'col-md-6';
                col.innerHTML = `
                    <label class="form-label text-white-50 small">Duration</label>
                    <select name="duration" class="form-select form-select-sm bg-dark text-white border-secondary" onchange="app.calcCost()">
                        ${m.durations.map(d => `<option value="${d}">${d}s</option>`).join('')}
                    </select>
                `;
                container.appendChild(col);
            }

            this.calcCost();
        },

        calcCost() {
            const m = MODELS.find(x => x.id === this.state.modelId);
            if (!m) return;

            let cost = 10;
            // Costs logic from JSON
            if (m.costs && m.costs.base) {
                cost = m.costs.base;
                // Add logic for multipliers (e.g. duration)
            }

            const btnCost = document.getElementById('costBadge');
            btnCost.textContent = cost + ' CR';

            // Summary text
            const res = document.querySelector('select[name="resolution"]')?.value || 'Default';
            const dur = document.querySelector('select[name="duration"]')?.value;
            let text = `${this.state.mode.toUpperCase()} | ${res}`;
            if (dur) text += ` | ${dur}s`;
            document.getElementById('paramsSummary').textContent = text;
        },

        updateState() {
            const prompt = document.getElementById('promptInput').value;
            const btn = document.getElementById('mainGenerateBtn');
            const msg = document.getElementById('emptyPromptMsg');

            if (!prompt.trim()) {
                btn.disabled = true;
                // msg.classList.remove('d-none'); // Only show on hover/focus? 
            } else {
                btn.disabled = false;
                msg.classList.add('d-none');
            }
        },

        fantazise() {
            const prompts = [
                "A cyberpunk street food vendor in Tokyo, neon lights, rain, high detail",
                "A majestic lion wearing a space suit, digital art, 8k",
                "Abstract fluid colors, oil painting texture, vibrant",
                "Portrait of a robot with human emotions, cinematic lighting"
            ];
            const p = prompts[Math.floor(Math.random() * prompts.length)];
            const el = document.getElementById('promptInput');
            el.value = p;
            this.updateState();
        }
    };

    // Global func for sidebar
    window.showSection = (sec) => {
        // Implement sidebar logic if needed to swap right pane content
        // For now user requested main page structure
        console.log("Nav to", sec);
    };

    document.addEventListener('DOMContentLoaded', () => app.init());
</script>
{% endblock %}