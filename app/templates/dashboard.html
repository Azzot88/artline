{% extends "base.html" %}

{% block content %}
<div class="container-fluid h-100 p-0" style="min-height: calc(100vh - 56px);">
    <div class="row g-0 h-100">

        <!-- LEFT COLUMN: Navigation & History (25%) -->
        <div class="col-lg-3 col-md-4 d-none d-md-flex flex-column border-end border-secondary bg-dark bg-opacity-50"
            style="backdrop-filter: blur(10px); height: calc(100vh - 56px); overflow-y: auto;">

            <!-- User Balance -->
            <div class="p-3 border-bottom border-secondary">
                {% if user %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    {% if user.email %}
                    <h6 class="mb-0 text-white-50 text-uppercase small ls-1">{{ t.balance_title|default('Balance') }}
                    </h6>
                    <a href="/services/billing" class="btn btn-sm btn-outline-success border-0"><i
                            class="bi bi-plus-lg"></i> Top Up</a>
                    {% else %}
                    <!-- Guest Mode -->
                    <h6 class="mb-0 text-white-50 text-uppercase small ls-1">Guest Mode</h6>
                    <a href="/register?next=/" class="btn btn-sm btn-outline-primary border-0">Sign Up</a>
                    {% endif %}
                </div>

                {% if user.email %}
                {% include "partials/balance_badge.html" %}
                {% endif %}

                {% else %}
                <div class="d-grid">
                    <a href="/login?next=/" class="btn btn-outline-light btn-sm mb-2">Sign In</a>
                    <a href="/register?next=/" class="btn btn-primary btn-sm">Create Account</a>
                </div>
                <div class="text-white-50 small mt-2">
                    Log in to save your generations and top up credits.
                </div>
                {% endif %}
            </div>

            <!-- Navigation Links -->
            <div class="list-group list-group-flush">
                <a href="#" class="list-group-item list-group-item-action bg-transparent text-white active border-0"
                    onclick="showSection('create')">
                    <i class="bi bi-magic me-2"></i> {{ t.nav_create|default('Create') }}
                </a>

                <!-- Gallery: Open to all -->
                <a href="#" class="list-group-item list-group-item-action bg-transparent text-white-50 border-0"
                    onclick="showSection('gallery')">
                    <i class="bi bi-images me-2"></i> {{ t.nav_gallery|default('Gallery') }}
                </a>

                {% if user %}
                <a href="#" class="list-group-item list-group-item-action bg-transparent text-white-50 border-0"
                    onclick="showSection('history')">
                    <i class="bi bi-clock-history me-2"></i> {{ t.nav_history|default('History') }}
                </a>
                {% endif %}
            </div>

            <!-- Mini Gallery / Recent -->
            <div class="p-3 mt-auto">
                <h6 class="text-white-50 text-uppercase small ls-1 mb-3">Recent Generations</h6>
                <div id="mini-gallery" class="d-grid gap-2" style="grid-template-columns: repeat(3, 1fr);"
                    hx-get="/jobs/partial?view=sidebar" hx-trigger="load, jobsChanged from:body">
                    {% include "partials/sidebar_recent.html" %}
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Workspace (Remaining width) -->
        <div class="col-lg-9 col-md-8 bg-black">
            <!-- Fluid Container for Full Width -->
            <div class="container-fluid py-4">

                <!-- Main Form (Full Width) -->
                <form id="generateForm" hx-post="/jobs/new" hx-swap="none" class="position-relative mb-5">
                    <!-- Main Card Container -->
                    <div class="card border border-secondary shadow-lg overflow-hidden"
                        style="background-color: #0f0f0f; border-color: #333 !important; border-radius: 12px;">

                        <!-- Header: Toggles & Tabs -->
                        <div class="card-header border-0 pb-0 pt-3 px-4 d-flex align-items-center mb-2"
                            style="background: transparent;">
                            <!-- Mode Switch (Custom Icons) -->
                            <div class="d-flex gap-3 me-4 align-items-center">
                                <input type="radio" class="btn-check" name="kind" id="modeImage" value="image" checked
                                    onchange="app.setMode('image')">
                                <label class="cursor-pointer mode-icon-label" for="modeImage" title="Image Mode">
                                    <img src="/static/icons/mode_image.png" class="mode-icon rounded-3" width="42"
                                        height="42">
                                </label>

                                <input type="radio" class="btn-check" name="kind" id="modeVideo" value="video"
                                    onchange="app.setMode('video')">
                                <label class="cursor-pointer mode-icon-label" for="modeVideo" title="Video Mode">
                                    <img src="/static/icons/mode_video.png" class="mode-icon rounded-3" width="42"
                                        height="42">
                                </label>
                            </div>

                            <style>
                                .mode-icon {
                                    transition: all 0.2s ease;
                                    opacity: 0.4;
                                    border: 1px solid transparent;
                                    filter: grayscale(100%);
                                }

                                .mode-icon:hover {
                                    opacity: 0.7;
                                    filter: grayscale(0%);
                                }

                                /* Active State */
                                .btn-check:checked+label .mode-icon {
                                    opacity: 1;
                                    border-color: rgba(255, 255, 255, 0.2);
                                    box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
                                    filter: grayscale(0%);
                                }
                            </style>

                            <!-- Source Tabs -->
                            <div class="d-flex gap-4">
                                <div class="cursor-pointer pb-2 border-bottom border-2 border-transparent text-white-50 fw-bold header-tab"
                                    id="tabText" onclick="app.setSource('text')">
                                    Text to Image
                                </div>
                                <div class="cursor-pointer pb-2 border-bottom border-2 border-white text-white fw-bold header-tab"
                                    id="tabImage" onclick="app.setSource('image')">
                                    Image to Image
                                </div>
                            </div>

                            <div class="ms-auto text-white-50 small">
                                <i class="bi bi-info-circle"></i> Prompt tips
                            </div>
                        </div>

                        <!-- Body: Upload & Prompt -->
                        <div class="card-body px-4 py-2" style="min-height: 140px;">

                            <!-- Image Input Trigger (Small Icon) -->
                            <div id="uploadArea" class="mb-2 d-none">
                                <div class="d-inline-block border border-secondary rounded p-2 text-center cursor-pointer hover-white position-relative"
                                    style="width: 48px; height: 48px; border-style: dashed !important;"
                                    onclick="document.getElementById('fileInput').click()">
                                    <i class="bi bi-plus-lg text-white-50"></i>

                                    <!-- Preview Overlay -->
                                    <div id="miniPreview"
                                        class="position-absolute top-0 start-0 w-100 h-100 d-none bg-dark rounded overflow-hidden">
                                        <img src="" class="w-100 h-100 object-fit-cover" id="imgPreviewTag">
                                    </div>
                                </div>
                                <input type="file" id="fileInput" name="init_image" class="d-none"
                                    onchange="app.handleFile(this)">
                                <button type="button" class="btn btn-link btn-sm text-danger p-0 ms-2 align-top d-none"
                                    id="clearFileBtn" onclick="app.clearFile()">x</button>
                            </div>

                            <!-- Input Field -->
                            <textarea name="prompt" id="promptInput"
                                class="form-control bg-transparent border-0 text-white px-0 fs-5"
                                style="resize: none; box-shadow: none;" rows="3"
                                placeholder="Describe how to transform your image (e.g. 'swap the sky with a sunset') or blend 2-3 images..."
                                required oninput="app.updateState()">ducks in bikini in spaceship</textarea>
                        </div>

                        <!-- Footer: Controls -->
                        <div class="card-footer bg-transparent border-0 px-4 pb-4 pt-2">

                            <!-- Limits / Warning -->
                            <div id="limitMsg" class="text-warning small mb-3 d-none">
                                You've reached your free limit. <a href="/services/billing"
                                    class="text-warning fw-bold">Subscribe now</a> to keep generating.
                            </div>

                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">

                                <!-- Left: Selectors -->
                                <div class="d-flex gap-2">
                                    <!-- Model Selector -->
                                    <div class="dropdown">
                                        <button
                                            class="btn btn-dark border border-secondary rounded-3 text-start d-flex align-items-center gap-2 px-3"
                                            type="button" data-bs-toggle="dropdown" style="background: #222;">
                                            <span id="selectedModelIcon">üçå</span>
                                            <span id="selectedModelName" class="text-white small fw-bold">Select
                                                Model</span>
                                            <i class="bi bi-chevron-down ms-2 text-white-50 small"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-dark shadow-lg p-0" id="modelDropdown"
                                            style="max-height: 300px; overflow-y: auto;">
                                            <!-- JS Populated -->
                                        </ul>
                                        <input type="hidden" name="model" id="selectedModelInput">
                                    </div>

                                    <!-- Aspect Ratio Selector -->
                                    <div class="dropdown">
                                        <button
                                            class="btn btn-dark border border-secondary rounded-3 d-flex align-items-center gap-2 px-3"
                                            type="button" data-bs-toggle="dropdown" style="background: #222;">
                                            <i class="bi bi-square"></i>
                                            <span id="selectedRatio" class="text-white small fw-bold">1:1</span>
                                            <i class="bi bi-chevron-down text-white-50 small"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-dark shadow-lg" id="ratioDropdown">
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="app.setRatio('1024x1024', '1:1')"><i
                                                        class="bi bi-square me-2"></i> 1:1 (Square)</a></li>
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="app.setRatio('896x1152', '3:4')"><i
                                                        class="bi bi-phone me-2"></i> 3:4 (Portrait)</a></li>
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="app.setRatio('1152x896', '4:3')"><i
                                                        class="bi bi-aspect-ratio me-2"></i> 4:3 (Landscape)</a></li>
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="app.setRatio('1344x768', '16:9')"><i
                                                        class="bi bi-film me-2"></i> 16:9 (Wide)</a></li>
                                        </ul>
                                        <input type="hidden" name="resolution" id="selectedRatioInput">
                                    </div>

                                    <!-- Additional Params Container (Hidden by default, used for durations etc) -->
                                    <div id="extraParams" class="d-none"></div>
                                </div>

                                <!-- Right: Generate Button -->
                                <div>
                                    {% if user.email %}
                                    <button type="submit" id="mainGenerateBtn"
                                        class="btn btn-warning fw-bold px-4 py-2 d-flex align-items-center gap-2"
                                        style="background-color: #ffd600; border: none; color: #000;">
                                        –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å <span id="costDisplay">100</span> <i class="bi bi-stars"></i>
                                    </button>
                                    {% else %}
                                    <button type="submit" id="mainGenerateBtn"
                                        class="btn btn-warning fw-bold px-4 py-2 d-flex align-items-center gap-2"
                                        style="background-color: #ffd600; border: none; color: #000;">
                                        –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å <i class="bi bi-stars"></i>
                                    </button>
                                    {% endif %}

                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- 2. Community Gallery (Masonry) -->
                <div>
                    <h5 class="text-white-50 mb-3 text-uppercase ls-1 px-1">Community Creations</h5>
                    <div id="gallery-container" hx-get="/gallery/page/1" hx-trigger="load" class="masonry-grid">
                        <div class="text-center text-muted py-5">Loading gallery...</div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script id="models-data" type="application/json">
    {{ models_json| safe }}
</script>
<script>
    // Embed Models Data
    const MODELS = JSON.parse(document.getElementById('models-data').textContent);

    const app = {
        state: {
            mode: 'image', // image | video
            source: 'text', // text | image
            modelId: null,
            hasFile: false
        },

        init() {
            this.setMode('image');
            // Auto select first valid model
            this.updateModels();
            this.setRatio('1024x1024', '1:1'); // Default default
        },

        setMode(mode) {
            this.state.mode = mode;

            // Update UI Labels
            const txtBtn = document.getElementById('tabText');
            const imgBtn = document.getElementById('tabImage');

            const suffix = mode === 'image' ? 'Image' : 'Video';
            txtBtn.textContent = `Text to ${suffix}`;
            imgBtn.textContent = `Image to ${suffix}`;

            // Update Tab Styles (border-bottom white vs transparent)
            if (this.state.source === 'text') {
                // handled in setSource
            }

            this.setSource('text');
            this.updateModels();
        },

        setSource(source) {
            this.state.source = source;

            const txtBtn = document.getElementById('tabText');
            const imgBtn = document.getElementById('tabImage');
            const uploadArea = document.getElementById('uploadArea');

            if (source === 'text') {
                txtBtn.classList.remove('border-transparent', 'text-white-50');
                txtBtn.classList.add('border-white', 'text-white');

                imgBtn.classList.add('border-transparent', 'text-white-50');
                imgBtn.classList.remove('border-white', 'text-white');

                uploadArea.classList.add('d-none');
            } else {
                imgBtn.classList.remove('border-transparent', 'text-white-50');
                imgBtn.classList.add('border-white', 'text-white');

                txtBtn.classList.add('border-transparent', 'text-white-50');
                txtBtn.classList.remove('border-white', 'text-white');

                uploadArea.classList.remove('d-none');
            }

            this.updateModels();
        },

        handleFile(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const prev = document.getElementById('miniPreview');
                    const img = document.getElementById('imgPreviewTag');
                    const clearBtn = document.getElementById('clearFileBtn');

                    prev.classList.remove('d-none');
                    img.src = e.target.result;
                    clearBtn.classList.remove('d-none');

                    this.state.hasFile = true;
                };
                reader.readAsDataURL(input.files[0]);
            }
        },

        clearFile() {
            document.getElementById('fileInput').value = '';
            document.getElementById('miniPreview').classList.add('d-none');
            document.getElementById('clearFileBtn').classList.add('d-none');
            this.state.hasFile = false;
        },

        updateModels() {
            const listContainer = document.getElementById('modelDropdown');
            listContainer.innerHTML = '';

            // Filter Models
            const neededMode = this.state.source === 'text'
                ? `text-to-${this.state.mode}`
                : `image-to-${this.state.mode}`;

            const validModels = MODELS.filter(m => {
                if (!m.modes || m.modes.length === 0) return this.state.mode === 'image' && this.state.source === 'text';
                return m.modes.includes(neededMode);
            });

            if (validModels.length === 0) {
                listContainer.innerHTML = '<li><span class="dropdown-item disabled">No models available</span></li>';
                this.selectModel(null);
                return;
            }

            validModels.forEach((m, idx) => {
                // Determine icon based on provider or explicit meta? 
                const icon = m.provider === 'replicate' ? '‚ö°' : 'ü§ñ';

                const li = document.createElement('li');
                li.innerHTML = `
                    <a class="dropdown-item d-flex align-items-center gap-2" href="#" onclick="app.selectModel('${m.id}')">
                        <span class="fs-5">${icon}</span>
                        <div>
                            <div class="fw-bold small">${m.name}</div>
                            <div class="text-muted" style="font-size: 0.7rem;">${m.provider}</div>
                        </div>
                    </a>
                `;
                listContainer.appendChild(li);

                // Auto Select first
                if (idx === 0 && !this.state.modelId) {
                    this.selectModel(m.id);
                }
            });

            // If current selection is invalid for new mode, reset
            if (this.state.modelId && !validModels.find(x => x.id === this.state.modelId)) {
                this.selectModel(validModels[0]?.id || null);
            }
        },

        selectModel(id) {
            this.state.modelId = id;
            document.getElementById('selectedModelInput').value = id || '';

            const m = MODELS.find(x => x.id === id);

            const displayParams = document.getElementById('selectedModelName');
            const displayIcon = document.getElementById('selectedModelIcon');

            if (m) {
                displayParams.textContent = m.name;
                displayIcon.textContent = m.provider === 'replicate' ? '‚ö°' : 'ü§ñ';
            } else {
                displayParams.textContent = "Select Model";
                displayIcon.textContent = "‚ùì";
            }

            this.calcCost();
        },

        setRatio(res, label) {
            document.getElementById('selectedRatioInput').value = res;
            document.getElementById('selectedRatio').textContent = label;

            // Also update icon based on label?
            // For now simple text update
            this.calcCost();
        },

        calcCost() {
            const m = MODELS.find(x => x.id === this.state.modelId);
            if (!m) return;

            let cost = 10;
            if (m.costs && m.costs.base) {
                cost = m.costs.base;
            }

            // Check video duration multiplier if relevant
            if (this.state.mode === 'video') {
                cost = 50; // Hardcode fallback or read from m.costs
            }

            const btnCost = document.getElementById('costDisplay');
            btnCost.textContent = cost + ' CR';

            // Check balance limit
            // We don't have user balance in JS context easily unless embedded.
            // But we can show warning if we did.
        },

        updateState() {
            const prompt = document.getElementById('promptInput').value;
            const btn = document.getElementById('mainGenerateBtn');
            const msg = document.getElementById('emptyPromptMsg');

            if (!prompt.trim()) {
                btn.disabled = true;
                msg.classList.remove('d-none');
            } else {
                btn.disabled = false;
                msg.classList.add('d-none');
            }
        },

        fantazise() {
            const prompts = [
                "A cyberpunk street food vendor in Tokyo, neon lights, rain, high detail",
                "A majestic lion wearing a space suit, digital art, 8k",
                "Abstract fluid colors, oil painting texture, vibrant",
                "Portrait of a robot with human emotions, cinematic lighting"
            ];
            const p = prompts[Math.floor(Math.random() * prompts.length)];
            const el = document.getElementById('promptInput');
            el.value = p;
            this.updateState();
        }
    };

    document.addEventListener('DOMContentLoaded', () => app.init());
</script>
{% endblock %}