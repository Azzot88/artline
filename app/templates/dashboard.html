{% extends "base.html" %}

{% block content %}
<div class="container-fluid h-100 p-0" style="min-height: calc(100vh - 56px);">
    <div class="row g-0 h-100">

        <!-- LEFT COLUMN: Navigation & History (25%) -->
        <div class="col-lg-3 col-md-4 d-none d-md-flex flex-column border-end border-secondary bg-dark bg-opacity-50"
            style="backdrop-filter: blur(10px); height: calc(100vh - 56px); overflow-y: auto;">

            <!-- User Balance -->
            <div class="p-3 border-bottom border-secondary">
                {% if user %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    {% if user.email %}
                    <h6 class="mb-0 text-white-50 text-uppercase small ls-1">{{ t.balance_title|default('Balance') }}
                    </h6>
                    <a href="/services/billing" class="btn btn-sm btn-outline-success border-0"><i
                            class="bi bi-plus-lg"></i> Top Up</a>
                    {% else %}
                    <!-- Guest Mode -->
                    <h6 class="mb-0 text-white-50 text-uppercase small ls-1">Guest Mode</h6>
                    <a href="/register?next=/" class="btn btn-sm btn-outline-primary border-0">Sign Up</a>
                    {% endif %}
                </div>

                {% if user.email %}
                {% include "partials/balance_badge.html" %}
                {% endif %}

                {% else %}
                <div class="d-grid">
                    <a href="/login?next=/" class="btn btn-outline-light btn-sm mb-2">Sign In</a>
                    <a href="/register?next=/" class="btn btn-primary btn-sm">Create Account</a>
                </div>
                <div class="text-white-50 small mt-2">
                    Log in to save your generations and top up credits.
                </div>
                {% endif %}
            </div>

            <!-- Navigation Links -->
            <div class="list-group list-group-flush">
                <a href="#" class="list-group-item list-group-item-action bg-transparent text-white active border-0"
                    onclick="showSection('create')">
                    <i class="bi bi-magic me-2"></i> {{ t.nav_create|default('Create') }}
                </a>

                <!-- Gallery: Open to all -->
                <a href="#" class="list-group-item list-group-item-action bg-transparent text-white-50 border-0"
                    onclick="showSection('gallery')">
                    <i class="bi bi-images me-2"></i> {{ t.nav_gallery|default('Gallery') }}
                </a>

                {% if user %}
                <a href="#" class="list-group-item list-group-item-action bg-transparent text-white-50 border-0"
                    onclick="showSection('history')">
                    <i class="bi bi-clock-history me-2"></i> {{ t.nav_history|default('History') }}
                </a>
                {% endif %}
            </div>

            <!-- Mini Gallery / Recent -->
            <div class="p-3 mt-auto">
                <h6 class="text-white-50 text-uppercase small ls-1 mb-3">Recent Generations</h6>
                <div id="mini-gallery" class="d-grid gap-2" style="grid-template-columns: repeat(3, 1fr);"
                    hx-get="/jobs/partial?view=sidebar" hx-trigger="load, jobsChanged from:body">
                    {% include "partials/sidebar_recent.html" %}
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Workspace (Remaining width) -->
        <div class="col-lg-9 col-md-8 bg-black">
            <!-- Fluid Container for Full Width -->
            <div class="container-fluid py-4">

                <!-- Main Form (Full Width) -->
                <form id="generateForm" onsubmit="app.submitJob(event)" class="position-relative mb-5">
                    <!-- Main Card Container -->
                    <div class="card border border-secondary shadow-lg overflow-hidden"
                        style="background-color: #0f0f0f; border-color: #333 !important; border-radius: 12px;">

                        <!-- Header: Toggles & Tabs -->
                        <div class="card-header border-0 pb-0 pt-3 px-4 d-flex align-items-center mb-2"
                            style="background: transparent;">
                            <!-- Mode Switch (Custom Icons) -->
                            <div class="d-flex gap-3 me-4 align-items-center">
                                <input type="radio" class="btn-check" name="kind" id="modeImage" value="image" checked
                                    onchange="app.setMode('image')">
                                <label class="cursor-pointer mode-icon-label" for="modeImage" title="Image Mode">
                                    <img src="/static/icons/mode_image.png" class="mode-icon rounded-3" width="42"
                                        height="42">
                                </label>

                                <input type="radio" class="btn-check" name="kind" id="modeVideo" value="video"
                                    onchange="app.setMode('video')">
                                <label class="cursor-pointer mode-icon-label" for="modeVideo" title="Video Mode">
                                    <img src="/static/icons/mode_video.png" class="mode-icon rounded-3" width="42"
                                        height="42">
                                </label>
                            </div>

                            <style>
                                .mode-icon {
                                    transition: all 0.2s ease;
                                    opacity: 0.4;
                                    border: 1px solid transparent;
                                    filter: grayscale(100%);
                                }

                                .mode-icon:hover {
                                    opacity: 0.7;
                                    filter: grayscale(0%);
                                }

                                /* Active State */
                                .btn-check:checked+label .mode-icon {
                                    opacity: 1;
                                    border-color: rgba(255, 255, 255, 0.2);
                                    box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
                                    filter: grayscale(0%);
                                }
                            </style>

                            <!-- Source Tabs -->
                            <div class="d-flex gap-4">
                                <div class="cursor-pointer pb-2 border-bottom border-2 border-transparent text-white-50 fw-bold header-tab"
                                    id="tabText" onclick="app.setSource('text')">
                                    Text to Image
                                </div>
                                <div class="cursor-pointer pb-2 border-bottom border-2 border-white text-white fw-bold header-tab"
                                    id="tabImage" onclick="app.setSource('image')">
                                    Image to Image
                                </div>
                            </div>

                            <div class="ms-auto text-white-50 small">
                                <i class="bi bi-info-circle"></i> Prompt tips
                            </div>
                        </div>

                        <!-- Body: Upload & Prompt -->
                        <div class="card-body px-4 py-2" style="min-height: 140px;">

                            <!-- Image Input Trigger (Small Icon) -->
                            <div id="uploadArea" class="mb-2 d-none">
                                <div class="d-inline-block border border-secondary rounded p-2 text-center cursor-pointer hover-white position-relative"
                                    style="width: 48px; height: 48px; border-style: dashed !important;"
                                    onclick="document.getElementById('fileInput').click()">
                                    <i class="bi bi-plus-lg text-white-50"></i>

                                    <!-- Preview Overlay -->
                                    <div id="miniPreview"
                                        class="position-absolute top-0 start-0 w-100 h-100 d-none bg-dark rounded overflow-hidden">
                                        <img src="" class="w-100 h-100 object-fit-cover" id="imgPreviewTag">
                                    </div>
                                </div>
                                <input type="file" id="fileInput" name="init_image" class="d-none"
                                    onchange="app.handleFile(this)">
                                <button type="button" class="btn btn-link btn-sm text-danger p-0 ms-2 align-top d-none"
                                    id="clearFileBtn" onclick="app.clearFile()">x</button>
                            </div>

                            <!-- Input Field -->
                            <textarea name="prompt" id="promptInput"
                                class="form-control bg-transparent border-0 text-white px-0 fs-5"
                                style="resize: none; box-shadow: none;" rows="3"
                                placeholder="Describe how to transform your image (e.g. 'swap the sky with a sunset') or blend 2-3 images..."
                                required oninput="app.updateState()">ducks in bikini in spaceship</textarea>
                        </div>

                        <!-- Footer: Controls -->
                        <div class="card-footer bg-transparent border-0 px-4 pb-4 pt-2">

                            <!-- Limits / Warning -->
                            <div id="limitMsg" class="text-warning small mb-3 d-none">
                                You've reached your free limit. <a href="/services/billing"
                                    class="text-warning fw-bold">Subscribe now</a> to keep generating.
                            </div>

                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">

                                <!-- Left: Selectors -->
                                <div class="d-flex gap-2">
                                    <!-- Model Selector -->
                                    <div class="dropdown">
                                        <button
                                            class="btn btn-dark border border-secondary rounded-3 text-start d-flex align-items-center gap-2 px-3"
                                            type="button" data-bs-toggle="dropdown" style="background: #222;">
                                            <span id="selectedModelIcon">üçå</span>
                                            <span id="selectedModelName" class="text-white small fw-bold">Select
                                                Model</span>
                                            <i class="bi bi-chevron-down ms-2 text-white-50 small"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-dark shadow-lg p-0" id="modelDropdown"
                                            style="max-height: 300px; overflow-y: auto;">
                                            <!-- JS Populated -->
                                        </ul>
                                        <input type="hidden" name="model" id="selectedModelInput">
                                    </div>

                                    <!-- Aspect Ratio Keys -->
                                    <div id="aspectRatioContainer" class="d-flex gap-2">
                                        <!-- JS Populated -->
                                    </div>
                                    <input type="hidden" name="aspect_ratio" id="aspectRatioInput" value="1:1">

                                    <!-- Additional Params Container -->
                                    <div id="extraParams" class="d-none"></div>
                                </div>

                                <!-- Right: Generate Button -->
                                <div>
                                    {% if user.email %}
                                    <button type="submit" id="mainGenerateBtn"
                                        class="btn btn-warning fw-bold px-4 py-2 d-flex align-items-center gap-2"
                                        style="background-color: #ffd600; border: none; color: #000;">
                                        –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å <span id="costDisplay">100</span> <i class="bi bi-stars"></i>
                                    </button>
                                    {% else %}
                                    <button type="submit" id="mainGenerateBtn"
                                        class="btn btn-warning fw-bold px-4 py-2 d-flex align-items-center gap-2"
                                        style="background-color: #ffd600; border: none; color: #000;">
                                        –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å <i class="bi bi-stars"></i>
                                    </button>
                                    {% endif %}

                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- 2. Community Gallery (Masonry) -->
                <div>
                    <h5 class="text-white-50 mb-3 text-uppercase ls-1 px-1">Community Creations</h5>
                    <div id="gallery-container" hx-get="/gallery/page/1" hx-trigger="load" class="masonry-grid">
                        <div class="text-center text-muted py-5">Loading gallery...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script id="models-data" type="application/json">
    {{ models_json| safe }}
</script>
<script>
    const app = {
        state: {
            mode: 'image', // image | video
            source: 'text', // text | image
            modelId: null,
            hasFile: false,
            models: [], // Loaded from API
            params: {} // Dynamic params
        },

        async init() {
            this.setMode('image');

            // Fetch Models
            try {
                const res = await fetch('/models/for-ui');
                this.state.models = await res.json();
                this.updateModels();
            } catch (e) {
                console.error("Failed to load models", e);
                // Fallback or alert?
            }
        },

        setMode(mode) {
            this.state.mode = mode;
            const suffix = mode === 'image' ? 'Image' : 'Video';
            document.getElementById('tabText').textContent = `Text to ${suffix}`;
            document.getElementById('tabImage').textContent = `Image to ${suffix}`;
            this.setSource('text');
            this.updateModels();
        },

        setSource(source) {
            this.state.source = source;
            const txtBtn = document.getElementById('tabText');
            const imgBtn = document.getElementById('tabImage');
            const uploadArea = document.getElementById('uploadArea');

            if (source === 'text') {
                txtBtn.classList.replace('border-transparent', 'border-white');
                txtBtn.classList.replace('text-white-50', 'text-white');
                imgBtn.classList.replace('border-white', 'border-transparent');
                imgBtn.classList.replace('text-white', 'text-white-50');
                uploadArea.classList.add('d-none');
            } else {
                imgBtn.classList.replace('border-transparent', 'border-white');
                imgBtn.classList.replace('text-white-50', 'text-white');
                txtBtn.classList.replace('border-white', 'border-transparent');
                txtBtn.classList.replace('text-white', 'text-white-50');
                uploadArea.classList.remove('d-none');
            }
            this.updateModels();
        },

        updateModels() {
            const listContainer = document.getElementById('modelDropdown');
            listContainer.innerHTML = '';

            // Filter Models
            const neededMode = this.state.source === 'text'
                ? `text-to-${this.state.mode}`
                : `image-to-${this.state.mode}`;

            // If model has no modes defined, assume it supports image gen (fallback)
            const validModels = this.state.models.filter(m => {
                const modes = m.modes || [];
                if (modes.length === 0) return this.state.mode === 'image';
                return modes.includes(neededMode);
            });

            if (validModels.length === 0) {
                listContainer.innerHTML = '<li><span class="dropdown-item disabled">No models available</span></li>';
                this.selectModel(null);
                return;
            }

            validModels.forEach((m, idx) => {
                const icon = m.provider === 'replicate' ? '‚ö°' : 'ü§ñ';
                const li = document.createElement('li');
                li.innerHTML = `
                    <a class="dropdown-item d-flex align-items-center gap-2" href="#" onclick="app.selectModel('${m.id}')">
                        <span class="fs-5">${icon}</span>
                        <div>
                            <div class="fw-bold small">${m.name}</div>
                            <div class="text-muted" style="font-size: 0.7rem;">${m.provider}</div>
                        </div>
                    </a>
                `;
                listContainer.appendChild(li);

                if (idx === 0 && !this.state.modelId) {
                    this.selectModel(m.id);
                }
            });

            // Ensure selected model is still valid
            if (this.state.modelId && !validModels.find(x => x.id === this.state.modelId)) {
                this.selectModel(validModels[0]?.id || null);
            }
        },

        selectModel(id) {
            this.state.modelId = id;
            document.getElementById('selectedModelInput').value = id || '';
            const m = this.state.models.find(x => x.id === id);

            const displayParams = document.getElementById('selectedModelName');
            const displayIcon = document.getElementById('selectedModelIcon');

            if (m) {
                displayParams.textContent = m.name;
                displayIcon.textContent = m.provider === 'replicate' ? '‚ö°' : 'ü§ñ';
                this.renderParams(m);
            } else {
                displayParams.textContent = "Select Model";
                displayIcon.textContent = "‚ùì";
                document.getElementById('aspectRatioContainer').innerHTML = '';
                document.getElementById('extraParams').innerHTML = '';
            }
        },

        renderParams(model) {
            const inputs = model.inputs || [];
            const defaults = model.defaults || {};

            // 1. Aspect Ratio (Special Container)
            const arInput = inputs.find(i => i.name === 'aspect_ratio');
            const arContainer = document.getElementById('aspectRatioContainer');
            arContainer.innerHTML = '';

            if (arInput && arInput.options) {
                arInput.options.forEach(val => {
                    // Format Label
                    let label = val;
                    if (val.includes("x")) {
                        const [w, h] = val.split("x").map(Number);
                        const r = w / h;
                        if (Math.abs(r - 1) < 0.1) label = "1:1";
                        else if (Math.abs(r - 16 / 9) < 0.1) label = "16:9";
                        else if (Math.abs(r - 9 / 16) < 0.1) label = "9:16";
                    }

                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn-sm btn-outline-secondary d-flex align-items-center gap-1 text-white-50';
                    btn.style.minWidth = "60px";
                    // Check Default
                    const isDefault = defaults['aspect_ratio'] === val || val === '1:1';
                    if (isDefault) btn.className += ' active text-white border-white';
                    if (isDefault) this.state.params['aspect_ratio'] = val;

                    btn.innerHTML = `<span class="small fw-bold">${label}</span>`;
                    btn.onclick = () => {
                        // Reset UI
                        Array.from(arContainer.children).forEach(c => c.classList.remove('active', 'text-white', 'border-white'));
                        btn.classList.add('active', 'text-white', 'border-white');
                        btn.classList.remove('text-white-50');
                        this.state.params['aspect_ratio'] = val;
                    };
                    arContainer.appendChild(btn);
                });
            } else {
                // If strictly no AR input in schema, maybe it's width/height sliders?
                // For MVP, just skip if not present.
            }

            // 2. Extra Params (Sliders, etc)
            const extraContainer = document.getElementById('extraParams');
            extraContainer.className = "d-none"; // hidden for now unless we add toggle
            // For MVP, we only render Aspect Ratio as primary control.
            // If user specifically requested *UI builds from /models/for-ui*, we should arguably support more.
            // But strict payload builder handles defaults.
            // Let's stick to AR for now as it's the main UI element.
        },

        async submitJob(e) {
            e.preventDefault();
            const btn = document.getElementById('mainGenerateBtn');
            const originalText = btn.innerHTML;

            if (!this.state.modelId) return alert("Please select a model");

            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...`;

            // Construct Payload
            const payload = {
                model_id: this.state.modelId,
                prompt: document.getElementById('promptInput').value,
                kind: this.state.mode,
                params: { ...this.state.params }
            };

            try {
                const res = await fetch('/jobs/new', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || "Generation failed");
                }

                // Success: Trigger Sidebar Update via HTMX or manual
                // Since this is manual fetch, we can manually trigger HTMX on body
                htmx.trigger('body', 'jobsChanged');
                htmx.trigger('body', 'balanceChanged');

                // Show toast/flash? 
                // For now, simple success state on button
                btn.innerHTML = `<i class="bi bi-check-lg"></i> Started`;
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }, 2000);

            } catch (err) {
                alert(err.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        },

        // ... (handleFile, clearFile, fantazise, updateState remained similar) ...
        handleFile(input) { /* ... */ },
        clearFile() { /* ... */ },
        updateState() { /* ... */ },
        fantazise() {
            const prompts = [
                "A cyberpunk street food vendor in Tokyo, neon lights, rain, high detail",
                "A majestic lion wearing a space suit, digital art, 8k",
                "Abstract fluid colors, oil painting texture, vibrant"
            ];
            const p = prompts[Math.floor(Math.random() * prompts.length)];
            document.getElementById('promptInput').value = p;
        }
    };

    document.addEventListener('DOMContentLoaded', () => app.init());
</script>{% endblock %}