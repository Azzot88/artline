{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ t.adm_prov_title }}</h1>
        <div class="btn-group">
            <form action="/admin/providers/seed" method="post" class="d-inline">
                <button class="btn btn-outline-warning me-2">{{ t.adm_btn_seed }}</button>
            </form>
            <a href="/admin" class="btn btn-outline-secondary">{{ t.adm_back_dash }}</a>
        </div>
    </div>

    <div class="row">
        <!-- List -->
        <div class="col-md-8">
            <div class="card glass-panel mb-4">
                <div class="card-header">{{ t.adm_prov_configured }}</div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>{{ t.adm_th_provider }}</th>
                                <th>{{ t.adm_th_name }}</th>
                                <th>{{ t.adm_th_key }}</th>
                                <th>{{ t.adm_th_status }}</th>
                                <th>{{ t.adm_th_updated }}</th>
                                <th>{{ t.adm_th_actions }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in configs %}
                            <tr>
                                <td>{{ c.provider_label }}</td>
                                <td>{{ c.name }}</td>
                                <td>{{ c.masked_key }}</td>
                                <td>
                                    {% if c.status == 'valid' %}
                                    <span class="badge bg-success">{{ t.adm_status_valid }}</span>
                                    {% elif c.status == 'invalid' %}
                                    <span class="badge bg-danger">{{ t.adm_status_invalid }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ t.adm_status_nottested }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ c.last_tested.strftime('%Y-%m-%d') if c.last_tested else '-' }}</td>
                                <td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info test-existing-btn"
                                        data-id="{{ c.id }}">Test</button>
                                    <form action="/admin/providers/delete" method="post" class="d-inline"
                                        onsubmit="return confirm('Delete?');">
                                        <input type="hidden" name="id" value="{{ c.id }}">
                                        <button class="btn btn-sm btn-outline-danger">{{ t.adm_btn_del }}</button>
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center text-muted">{{ t.adm_no_provs }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add Form -->
        <div class="col-md-4">
            <div class="card glass-panel">
                <div class="card-header">{{ t.adm_btn_add }}</div>
                <div class="card-body">
                    <form id="addProviderForm" action="/admin/providers/save" method="post">
                        <div class="mb-3">
                            <label class="form-label">{{ t.adm_th_provider }}</label>
                            <select name="provider_id" id="providerSelect" class="form-select" required
                                data-msg-spaces="{{ t.adm_js_spaces }}" data-msg-inv="{{ t.adm_js_invalid_fmt }}"
                                data-msg-pass="{{ t.adm_js_test_passed }}" data-msg-err="{{ t.adm_js_error }}"
                                data-msg-testing="{{ t.adm_js_testing }}">
                                <option value="" disabled selected>{{ t.adm_sel_placeholder }}</option>
                                {% for p in providers_list %}
                                <option value="{{ p.id }}">{{ p.label }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">{{ t.adm_lbl_name_alias }}</label>
                            <input type="text" name="name" class="form-control" placeholder="e.g. OpenAI Main">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">{{ t.adm_lbl_apikey }}</label>
                            <div class="input-group">
                                <input type="password" name="api_key" id="apiKeyInput" class="form-control" required>
                                <button class="btn btn-outline-secondary" type="button"
                                    onclick="toggleKEY()">üëÅÔ∏è</button>
                            </div>
                            <div id="validationMsg" class="form-text text-danger mt-1"></div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" id="testBtn" class="btn btn-outline-info" disabled>{{
                                t.adm_btn_test }}</button>
                            <button type="submit" id="saveBtn" class="btn btn-primary" disabled>{{
                                t.adm_btn_save }}</button>
                        </div>
                        <div id="testResult" class="mt-2 text-center"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Scripts preserved -->
<script>
    function toggleKEY() {
        const inp = document.getElementById('apiKeyInput');
        inp.type = inp.type === 'password' ? 'text' : 'password';
    }

    // Add Provider Form Logic
    const providerSelect = document.getElementById('providerSelect');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const validationMsg = document.getElementById('validationMsg');
    const saveBtn = document.getElementById('saveBtn');
    const testBtn = document.getElementById('testBtn');
    const testResult = document.getElementById('testResult');

    const regexMap = {
        'openai': /^sk-[A-Za-z0-9._-]{10,}$/,
        'stability': /^sk-[A-Za-z0-9._-]{10,}$/,
        'replicate': /^r8_[A-Za-z0-9]{37}$/,
        'runway': /^[A-Za-z0-9._-]{20,}$/,
        'luma': /^[A-Za-z0-9._-]{20,}$/
    };

    function validate() {
        const pid = providerSelect.value;
        const key = apiKeyInput.value.trim();

        if (!pid || !key) {
            saveBtn.disabled = true;
            testBtn.disabled = true;
            validationMsg.textContent = "";
            return;
        }

        if (/\s/.test(key)) {
            validationMsg.textContent = providerSelect.dataset.msgSpaces;
            saveBtn.disabled = true;
            testBtn.disabled = true;
            return;
        }

        const reg = regexMap[pid] || /.{5,}/;
        if (!reg.test(key)) {
            validationMsg.textContent = providerSelect.dataset.msgInv + " " + pid;
            saveBtn.disabled = true;
            testBtn.disabled = true;
        } else {
            validationMsg.textContent = "";
            saveBtn.disabled = false;
            testBtn.disabled = false;
        }
    }

    if (providerSelect) {
        providerSelect.addEventListener('change', validate);
        apiKeyInput.addEventListener('input', validate);

        testBtn.addEventListener('click', async () => {
            testBtn.disabled = true;
            testResult.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ' + providerSelect.dataset.msgTesting;

            const formData = new FormData();
            formData.append('provider_id', providerSelect.value);
            formData.append('api_key', apiKeyInput.value.trim());

            try {
                const res = await fetch('/admin/providers/test', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.ok) {
                    testResult.innerHTML = '<span class="text-success">‚úÖ ' + providerSelect.dataset.msgPass + '</span>';
                } else {
                    testResult.innerHTML = '<span class="text-danger">‚ùå ' + data.message + '</span>';
                }
            } catch (e) {
                testResult.innerHTML = '<span class="text-danger">' + providerSelect.dataset.msgErr + ': ' + e.message + '</span>';
            } finally {
                testBtn.disabled = false;
            }
        });
    }

    // Existing Providers Test Logic
    document.querySelectorAll('.test-existing-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const id = btn.dataset.id;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            try {
                const res = await fetch(`/admin/providers/${id}/test`, { method: 'POST' });
                const data = await res.json();

                // Find row elements
                const row = btn.closest('tr');
                const badgeCell = row.querySelector('td:nth-child(4)'); // 4th column is status
                const dateCell = row.querySelector('td:nth-child(5)'); // 5th column is date

                if (data.ok) {
                    badgeCell.innerHTML = '<span class="badge bg-success">' + '{{ t.adm_status_valid }}' + '</span>';
                    btn.classList.remove('btn-outline-info', 'btn-outline-danger');
                    btn.classList.add('btn-outline-success');
                    setTimeout(() => {
                        btn.classList.remove('btn-outline-success');
                        btn.classList.add('btn-outline-info');
                    }, 2000);
                } else {
                    badgeCell.innerHTML = '<span class="badge bg-danger">' + '{{ t.adm_status_invalid }}' + '</span> <small class="d-block text-muted" style="font-size:0.7em">' + data.message + '</small>';
                    btn.classList.remove('btn-outline-info');
                    btn.classList.add('btn-outline-danger');
                }

                if (data.last_tested) {
                    dateCell.textContent = data.last_tested;
                }

            } catch (e) {
                alert("Test Request Failed: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
    });

</script>
{% endblock %}