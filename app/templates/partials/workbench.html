<form id="generateForm" onsubmit="app.submitJob(event)" class="position-relative mb-5" hx-target="#gallery-container"
    hx-swap="afterbegin">
    <!-- Main Card Container -->
    <div class="card border border-secondary shadow-lg overflow-hidden"
        style="background-color: #0f0f0f; border-color: #333 !important; border-radius: 12px;">

        <!-- Header: Toggles & Tabs -->
        <div class="card-header border-0 pb-0 pt-3 px-4 d-flex align-items-center mb-2"
            style="background: transparent;">
            <!-- Mode Switch (Custom Icons) -->
            <div class="d-flex gap-3 me-4 align-items-center">
                <input type="radio" class="btn-check" name="kind" id="modeImage" value="image" checked
                    onchange="app.setMode('image')">
                <label class="cursor-pointer mode-icon-label" for="modeImage" title="Image Mode">
                    <img src="/static/icons/mode_image.png" class="mode-icon rounded-3" width="42" height="42">
                </label>

                <input type="radio" class="btn-check" name="kind" id="modeVideo" value="video"
                    onchange="app.setMode('video')">
                <label class="cursor-pointer mode-icon-label" for="modeVideo" title="Video Mode">
                    <img src="/static/icons/mode_video.png" class="mode-icon rounded-3" width="42" height="42">
                </label>
            </div>

            <style>
                .mode-icon {
                    transition: all 0.2s ease;
                    opacity: 0.4;
                    border: 1px solid transparent;
                    filter: grayscale(100%);
                }

                .mode-icon:hover {
                    opacity: 0.7;
                    filter: grayscale(0%);
                }

                /* Active State */
                .btn-check:checked+label .mode-icon {
                    opacity: 1;
                    border-color: rgba(255, 255, 255, 0.2);
                    box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
                    filter: grayscale(0%);
                }
            </style>

            <!-- Source Tabs -->
            <div class="d-flex gap-4">
                <div class="cursor-pointer pb-2 border-bottom border-2 border-transparent text-white-50 fw-bold header-tab"
                    id="tabText" onclick="app.setSource('text')">
                    Text to Image
                </div>
                <div class="cursor-pointer pb-2 border-bottom border-2 border-white text-white fw-bold header-tab"
                    id="tabImage" onclick="app.setSource('image')">
                    Image to Image
                </div>
            </div>

            <div class="ms-auto text-white-50 small">
                <i class="bi bi-info-circle"></i> Prompt tips
            </div>
        </div>

        <!-- Body: Upload & Prompt -->
        <div class="card-body px-4 py-2" style="min-height: 140px;">

            <!-- Image Input Trigger (Small Icon) -->
            <div id="uploadArea" class="mb-2 d-none">
                <div class="d-inline-block border border-secondary rounded p-2 text-center cursor-pointer hover-white position-relative"
                    style="width: 48px; height: 48px; border-style: dashed !important;"
                    onclick="document.getElementById('fileInput').click()">
                    <i class="bi bi-plus-lg text-white-50"></i>

                    <!-- Preview Overlay -->
                    <div id="miniPreview"
                        class="position-absolute top-0 start-0 w-100 h-100 d-none bg-dark rounded overflow-hidden">
                        <img src="" class="w-100 h-100 object-fit-cover" id="imgPreviewTag">
                    </div>
                </div>
                <input type="file" id="fileInput" name="init_image" class="d-none" onchange="app.handleFile(this)">
                <button type="button" class="btn btn-link btn-sm text-danger p-0 ms-2 align-top d-none"
                    id="clearFileBtn" onclick="app.clearFile()">x</button>
            </div>

            <!-- Input Field -->
            <textarea name="prompt" id="promptInput" class="form-control bg-transparent border-0 text-white px-0 fs-5"
                style="resize: none; box-shadow: none;" rows="3"
                placeholder="Describe how to transform your image (e.g. 'swap the sky with a sunset') or blend 2-3 images..."
                required oninput="app.updateState()">ducks in bikini in spaceship</textarea>
        </div>

        <!-- Footer: Controls -->
        <div class="card-footer bg-transparent border-0 px-4 pb-4 pt-2">

            <!-- Limits / Warning -->
            <div id="limitMsg" class="text-warning small mb-3 d-none">
                You've reached your free limit. <a href="/services/billing" class="text-warning fw-bold">Subscribe
                    now</a> to keep generating.
            </div>

            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">

                <!-- Left: Selectors -->
                <div class="d-flex gap-2">
                    <!-- Model Selector -->
                    <div class="dropdown">
                        <button
                            class="btn btn-dark border border-secondary rounded-3 text-start d-flex align-items-center gap-2 px-3"
                            type="button" data-bs-toggle="dropdown" style="background: #222;">
                            <span id="selectedModelIcon">üçå</span>
                            <span id="selectedModelName" class="text-white small fw-bold">Select
                                Model</span>
                            <i class="bi bi-chevron-down ms-2 text-white-50 small"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-dark shadow-lg p-0" id="modelDropdown"
                            style="max-height: 300px; overflow-y: auto;">
                            <!-- JS Populated -->
                        </ul>
                        <input type="hidden" name="model" id="selectedModelInput">
                    </div>

                    <!-- Aspect Ratio Keys -->
                    <div id="aspectRatioContainer" class="d-flex gap-2">
                        <!-- JS Populated -->
                    </div>
                    <input type="hidden" name="aspect_ratio" id="aspectRatioInput" value="1:1">

                    <!-- Additional Params Container -->
                    <div id="extraParams" class="d-none"></div>
                </div>

                <!-- Right: Generate Button -->
                <div>
                    {% if user and user.email %}
                    <button type="submit" id="mainGenerateBtn"
                        class="btn btn-warning fw-bold px-4 py-2 d-flex align-items-center gap-2"
                        style="background-color: #ffd600; border: none; color: #000;">
                        –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å <span id="costDisplay">100</span> <i class="bi bi-stars"></i>
                    </button>
                    {% else %}
                    <button type="submit" id="mainGenerateBtn"
                        class="btn btn-warning fw-bold px-4 py-2 d-flex align-items-center gap-2"
                        style="background-color: #ffd600; border: none; color: #000;">
                        –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å <i class="bi bi-stars"></i>
                    </button>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</form>