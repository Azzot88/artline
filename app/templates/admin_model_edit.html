{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Configure: <span class="text-primary">{{ model.model_ref }}</span></h3>
        <a href="/admin/models" class="btn btn-outline-secondary btn-sm">Back</a>
    </div>

    <form method="post" action="/admin/models/{{ model.id }}/save">
        <div class="row">
            <!-- Left: Settings -->
            <div class="col-md-7">
                <div class="card glass-panel mb-4">
                    <div class="card-header">General Settings</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Display Name</label>
                            <input type="text" name="display_name" class="form-control" value="{{ model.display_name }}"
                                required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cover Image URL</label>
                            <input type="text" name="cover_image_url" class="form-control"
                                value="{{ model.cover_image_url or '' }}">
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="is_active" id="isActive" {% if
                                model.is_active %}checked{% endif %}>
                            <label class="form-check-label" for="isActive">Model is Active (Visible to users)</label>
                        </div>
                    </div>
                </div>

                <div class="card glass-panel">
                    <div class="card-header">Input Parameters</div>
                    <div class="card-body p-0 table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-hover mb-0" style="font-size: 0.9rem;">
                            <thead class="sticky-top bg-dark">
                                <tr>
                                    <th>Show</th>
                                    <th>Parameter</th>
                                    <th>Type</th>
                                    <th>Label Alias</th>
                                    <th>Default Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for key, prop in schema_inputs.items() %}
                                {% set conf = (model.ui_config or {}).get(key, {}) %}
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="show_{{ key }}" {% if
                                                conf.get('visible', True) %}checked{% endif %}>
                                        </div>
                                    </td>
                                    <td>
                                        <code>{{ key }}</code>
                                        {% if prop.get('description') %}
                                        <i class="bi bi-info-circle text-muted" title="{{ prop.description }}"></i>
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-secondary">{{ prop.type }}</span></td>
                                    <td>
                                        <input type="text" name="label_{{ key }}" class="form-control form-control-sm"
                                            value="{{ conf.get('label', prop.title or key) }}">
                                    </td>
                                    <td>
                                        <input type="text" name="default_{{ key }}" class="form-control form-control-sm"
                                            value="{{ conf.get('default', prop.default) }}">
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right: Preview -->
            <div class="col-md-5">
                <div class="card glass-panel sticky-top" style="top: 20px;">
                    <div class="card-header">Test & Preview</div>
                    <div class="card-body">
                        <div class="alert alert-info small py-2">
                            Saving settings will update the form below. Test generation to ensure defaults work.
                        </div>
                        <div class="d-grid gap-2 mb-3">
                            <button type="submit" class="btn btn-primary">Save Configuration</button>
                        </div>
                        <hr>
                        <!-- Preview Form Target -->
                        <div id="previewFormContainer">
                            <!-- Helper to trigger preview generation without leaving page -->
                            <button type="button" class="btn btn-success w-100" id="runPreviewBtn">
                                Generate Preview
                            </button>
                        </div>
                        <div id="previewResult" class="mt-3 text-center">
                            {% if model.cover_image_url %}
                            <img src="{{ model.cover_image_url }}" class="img-fluid rounded border border-secondary">
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    document.getElementById('runPreviewBtn').addEventListener('click', async () => {
        const btn = document.getElementById('runPreviewBtn');
        const resDiv = document.getElementById('previewResult');

        // Disable saving first to ensure latest config is used? 
        // Ideally we save via AJAX then run, but for MVP we assume user saved.

        if (!confirm("Did you save your latest changes? We will use the saved configuration for the test.")) return;

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generating...';
        resDiv.innerHTML = '';

        try {
            const res = await fetch(`/admin/models/{{ model.id }}/preview`, { method: 'POST' });
            const data = await res.json();

            if (data.ok) {
                resDiv.innerHTML = `<img src="${data.url}" class="img-fluid rounded mb-2"><br><small class="text-success">Generated!</small>`;
                // Option to set cover
                if (confirm("Use this image as the model cover?")) {
                    document.querySelector('input[name=cover_image_url]').value = data.url;
                }
            } else {
                resDiv.innerHTML = `<div class="text-danger small">${data.error}</div>`;
            }
        } catch (e) {
            resDiv.innerHTML = `<div class="text-danger small">${e}</div>`;
        } finally {
            btn.disabled = false;
            btn.innerText = "Generate Preview";
        }
    });
</script>
{% endblock %}